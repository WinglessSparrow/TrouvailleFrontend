@page "/"

@using TrouvailleFrontend.Shared.Models
@using TrouvailleFrontend.Components.Index
@using TrouvailleFrontend.Components.Shared

@inject IProductIterator iterator
@inject NavigationManager navMan
@inject GlobalStateManager state

<div class="page">
    <div class="side-panel">
        <SideMenu>
            <SideMenuContentIndex @bind-Ascending=_ascending />
            @*
                <div class="overlay-under-construction">
                <p>Under Construction</p>
                </div>
            *@

        </SideMenu>
    </div>
    <div class="main-container">

        @if (_products != null)
        {
            @foreach (ProductModel p in _products)
            {
                <ProductSmall Product=p />
            }
        }
    </div>
    <div class="indexed-navigation">
        <button @onclick="prev" disabled="@_prevButton" class="next-prev-button">
            <Icon Name="IconName.ArrowLeft" />
            @* prev *@
        </button>
        <div class="page-numbers-container">
            @if (_numbers != null)
            {
                @for (int i = 1; i <= (_numbers.NumberOfProduct / _numbers.NumberProductsPerIteration) + 1; i++)
                {
                    var temp = i - 1;
                    <div class="page-number" @onclick="()=>ChangeToIndex(temp)">@i</div>
                }
            }
        </div>
        <button @onclick="next" disabled="@_nextButton" class="next-prev-button">
            @* next *@
            <Icon Name="IconName.ArrowRight" />
        </button>
    </div>
</div>

@code{
    [CascadingParameter]
    private CustomHeader _header { get; set; }
    private List<ProductModel> _products;
    private ProductsNumbersModel _numbers;
    private bool _ascending = false;

    private bool _nextButton = false;
    private bool _prevButton = false;
    protected override async Task OnInitializedAsync()
    {
        _numbers = await iterator.GetProductNumbersAsync();
        _products = await iterator.GetProductIndexedAsync(iterator.GetIndex());

        Console.WriteLine(state.Get<CustomHeader>());
        var f = state.Get<CustomHeader>();
        f.SearchTrigered += SearchAsync;
    }

    protected override void OnParametersSet()
    {
        if (_header != null)
        {

            @* _header.SearchTrigered += SearchAsync; *@
        }
    }


    private async Task SearchAsync(string word)
    {
        iterator.SearchWord = word;
        iterator.Ascending = _ascending;
        _products = await iterator.GetProductIndexedAsync(0);
        StateHasChanged();
        Console.WriteLine($"{word} + {_ascending}");
    }

    private async void next()
    {
        var temp = await iterator.GetNextProductsAsync();

        if (temp == null) _nextButton = true;
        else _products = temp;

        if (_prevButton) _prevButton = false;
        this.StateHasChanged();
    }

    private async void prev()
    {
        var temp = await iterator.GetPreviousProductsAsync();

        if (temp == null) _prevButton = true;
        else _products = temp;

        if (_nextButton) _nextButton = false;
        this.StateHasChanged();
    }

    private async void ChangeToIndex(int index)
    {
        _products = await iterator.GetProductIndexedAsync(index);
        if (_nextButton) _nextButton = false;
        if (_prevButton) _prevButton = false;
        this.StateHasChanged();
    }
}